<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ title }}</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800 font-sans">

<!-- Header -->
<header class="bg-blue-700 text-white shadow p-4 flex justify-between items-center">
  <h1 class="text-2xl font-bold">{{ title }}</h1>
  <div>Welcome, User</div>
</header>

<main class="container mx-auto p-4 space-y-6">

  <!-- Scan Section -->
  <section class="bg-white rounded-lg shadow p-4">
    <h2 class="text-xl font-semibold mb-2">Scan URL or File</h2>
    <form id="scanForm" class="flex flex-col md:flex-row gap-3">
      <input type="text" name="url" placeholder="Enter URL" class="border rounded px-3 py-2 w-full md:flex-1">
      <input type="file" name="file" class="border rounded px-3 py-2 w-full md:w-auto">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white rounded px-4 py-2">Scan</button>
    </form>
  </section>

  <!-- History Table -->
  <section class="bg-white rounded-lg shadow p-4 overflow-x-auto">
    <h2 class="text-xl font-semibold mb-2">Scan History</h2>
    <table class="w-full table-auto border-collapse">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-4 py-2">User ID</th>
          <th class="border px-4 py-2">Timestamp</th>
          <th class="border px-4 py-2">Input</th>
          <th class="border px-4 py-2">Type</th>
          <th class="border px-4 py-2">Verdict</th>
          <th class="border px-4 py-2">Score</th>
          <th class="border px-4 py-2">Details</th>
        </tr>
      </thead>
      <tbody id="historyTable"></tbody>
    </table>
  </section>

</main>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-lg shadow p-6 max-w-xl w-full max-h-[80%] overflow-auto">
    <h3 class="text-xl font-semibold mb-2">Scan Details</h3>
    <pre id="modalContent" class="bg-gray-100 p-2 rounded overflow-auto"></pre>
    <button onclick="closeModal()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Close</button>
  </div>
</div>

<script>
let historyData = [];
const historyTable = document.getElementById('historyTable');
const modal = document.getElementById('modal');
const modalContent = document.getElementById('modalContent');

async function fetchHistory() {
  try {
    const res = await fetch('/history.json');
    historyData = await res.json();
    renderTable();
  } catch(e) { console.error(e); }
}

function renderTable() {
  historyTable.innerHTML = '';
  historyData.slice().reverse().forEach((item, index) => {
    const verdictColor = item.verdict === 'phishing' ? 'red-500' : item.verdict === 'suspicious' ? 'yellow-500' : 'green-500';
    historyTable.innerHTML += `
      <tr class="hover:bg-gray-50">
        <td class="border px-4 py-2">${item.user_id || 'guest'}</td>
        <td class="border px-4 py-2">${item.timestamp}</td>
        <td class="border px-4 py-2">${item.input}</td>
        <td class="border px-4 py-2">${item.type}</td>
        <td class="border px-4 py-2 font-semibold text-${verdictColor}">${item.verdict}</td>
        <td class="border px-4 py-2">${item.final_score}</td>
        <td class="border px-4 py-2">
          <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="showDetails(${index})">View</button>
        </td>
      </tr>`;
  });
}

function showDetails(index){
  const item = historyData[historyData.length - 1 - index]; // reverse order
  modalContent.textContent = JSON.stringify(item, null, 2);
  modal.classList.remove('hidden');
}

function closeModal(){ modal.classList.add('hidden'); }

document.getElementById('scanForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const formData = new FormData(e.target);
  const res = await fetch('/scan', {method:'POST', body:formData});
  const data = await res.json();
  if(data.error) alert(data.error);
  else fetchHistory();
});

fetchHistory();
</script>

</body>
</html>
